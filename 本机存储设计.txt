flyfish本机存储需求

flyfish数据存储只追加，不需要查询。本机存储了对key的操作记录，当服务崩溃后，按序读取存储文件，重放操作实现内存数据的恢复。
只追加的方式将导致binlog文件太大，因此，当binlog文件超过一定大小后，对所有key做一次快照。

binlog文件存储内容

操作码 占一个字节包含以下类型

insert 插入完整记录，当数据不存在，执行插入时使用这个操作类型，打快照时也使用这个类型

update 更新字段

delete 删除记录

drop   记录被替换(即本进程不再缓存响应数据)

每一条binlog内容如下

一字节操作码

表名

__key__

__version__

字段<key:value> 只有insert|update才有


从binlog恢复


读到insert操作时创建cachekey对象，并根据binlog内容设置字段。

读到update操作时对cachekey更新相应字段。

读到delete操作时清空所有字段，将cachekey设置为missing。

读到drop将对应的cachekey从内存移除。


数据恢复后对所有cachekey打一次快照。删除旧的binlog文件。


为了避免打快照时锁定的cachekey过多，应该设置合理的CacheGroupSize。

每个CacheGroupSize管理自己的cachekey,维护单独的binlog文件。


















